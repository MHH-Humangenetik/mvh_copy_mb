<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MeldebestÃ¤tigungen Viewer</title>
    
    <!-- Milligram CSS -->
    <link rel="stylesheet" href="https://unpkg.com/milligram@1.4.1/dist/milligram.min.css">
    
    <!-- Custom RosÃ© Pine CSS -->
    <link rel="stylesheet" href="/static/css/custom.css">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
    
    <!-- Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.13.3" defer></script>
</head>
<body>
    <div class="container" x-data="tableData()">
        <h1>MeldebestÃ¤tigungen Viewer</h1>
        
        <!-- Loading indicator -->
        <div id="loading" class="htmx-indicator">
            <p>Loading...</p>
        </div>
        
        {% if error_message %}
        <div class="error-message">
            <p><strong>Error:</strong> {{ error_message }}</p>
        </div>
        {% else %}
        
        <!-- Filter input -->
        <div class="filter-container">
            <label for="filter">Filter:</label>
            <input 
                type="text" 
                id="filter" 
                x-model="filter" 
                placeholder="Search across all columns..."
                class="filter-input">
        </div>
        
        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th @click="sortBy('case_id')" class="sortable">
                            Case ID
                            <span x-show="sortColumn === 'case_id'">
                                <span x-show="sortDirection === 'asc'">â–²</span>
                                <span x-show="sortDirection === 'desc'">â–¼</span>
                            </span>
                        </th>
                        <th>Vorgangsnummer</th>
                        <th>IBE String</th>
                        <th>Art der Daten</th>
                        <th @click="sortBy('typ_der_meldung')" class="sortable">
                            Typ der Meldung
                            <span x-show="sortColumn === 'typ_der_meldung'">
                                <span x-show="sortDirection === 'asc'">â–²</span>
                                <span x-show="sortDirection === 'desc'">â–¼</span>
                            </span>
                        </th>
                        <th @click="sortBy('indikationsbereich')" class="sortable">
                            Indikationsbereich
                            <span x-show="sortColumn === 'indikationsbereich'">
                                <span x-show="sortDirection === 'asc'">â–²</span>
                                <span x-show="sortDirection === 'desc'">â–¼</span>
                            </span>
                        </th>
                        <th>Ergebnis QC</th>
                        <th @click="sortBy('source_file')" class="sortable">
                            Source File
                            <span x-show="sortColumn === 'source_file'">
                                <span x-show="sortDirection === 'asc'">â–²</span>
                                <span x-show="sortDirection === 'desc'">â–¼</span>
                            </span>
                        </th>
                        <th>Complete</th>
                        <th>Valid</th>
                        <th>Done</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="row in interleavedRows" :key="row.pair.case_id + '-' + row.type">
                        <tr class="pair-row"
                            :class="[row.type.includes('genomic') ? 'genomic' : 'clinical', 'priority-group-' + row.pair.priority_group]"
                            :data-case-id="row.pair.case_id"
                            :id="row.type === 'genomic' ? 'pair-genomic-' + row.pair.case_id : (row.type === 'clinical' ? 'pair-clinical-' + row.pair.case_id : '')">
                            <template x-if="row.type === 'genomic'">
                                <td class="case-id-cell" rowspan="2" x-text="row.pair.case_id"></td>
                            </template>
                            <template x-if="row.type === 'genomic-only' || row.type === 'clinical-only'">
                                <td class="case-id-cell" x-text="row.pair.case_id"></td>
                            </template>
                            <template x-if="row.type === 'genomic' || row.type === 'genomic-only'">
                                <td>
                                    <span x-text="row.pair.genomic.vorgangsnummer"></span>
                                    <span class="copy-btn" @click="copyToClipboard(row.pair.genomic.vorgangsnummer)" title="Copy to clipboard">ðŸ“‹</span>
                                </td>
                            </template>
                            <template x-if="row.type === 'clinical' || row.type === 'clinical-only'">
                                <td>
                                    <span x-text="row.pair.clinical.vorgangsnummer"></span>
                                    <span class="copy-btn" @click="copyToClipboard(row.pair.clinical.vorgangsnummer)" title="Copy to clipboard">ðŸ“‹</span>
                                </td>
                            </template>
                            <template x-if="row.type === 'genomic' || row.type === 'genomic-only'">
                                <td>
                                    <span x-text="row.pair.genomic.meldebestaetigung"></span>
                                    <span class="copy-btn" @click="copyToClipboard(row.pair.genomic.meldebestaetigung)" title="Copy to clipboard">ðŸ“‹</span>
                                </td>
                            </template>
                            <template x-if="row.type === 'clinical' || row.type === 'clinical-only'">
                                <td>
                                    <span x-text="row.pair.clinical.meldebestaetigung"></span>
                                    <span class="copy-btn" @click="copyToClipboard(row.pair.clinical.meldebestaetigung)" title="Copy to clipboard">ðŸ“‹</span>
                                </td>
                            </template>
                            <td x-text="row.type.includes('genomic') ? 'genomic' : 'clinical'"></td>
                            <template x-if="row.type === 'genomic' || row.type === 'genomic-only'">
                                <td x-text="row.pair.genomic.typ_der_meldung"></td>
                            </template>
                            <template x-if="row.type === 'clinical' || row.type === 'clinical-only'">
                                <td x-text="row.pair.clinical.typ_der_meldung"></td>
                            </template>
                            <template x-if="row.type === 'genomic' || row.type === 'genomic-only'">
                                <td x-text="row.pair.genomic.indikationsbereich"></td>
                            </template>
                            <template x-if="row.type === 'clinical' || row.type === 'clinical-only'">
                                <td x-text="row.pair.clinical.indikationsbereich"></td>
                            </template>
                            <template x-if="row.type === 'genomic' || row.type === 'genomic-only'">
                                <td x-text="row.pair.genomic.ergebnis_qc"></td>
                            </template>
                            <template x-if="row.type === 'clinical' || row.type === 'clinical-only'">
                                <td x-text="row.pair.clinical.ergebnis_qc"></td>
                            </template>
                            <template x-if="row.type === 'genomic' || row.type === 'genomic-only'">
                                <td x-text="row.pair.genomic.source_file"></td>
                            </template>
                            <template x-if="row.type === 'clinical' || row.type === 'clinical-only'">
                                <td x-text="row.pair.clinical.source_file"></td>
                            </template>
                            <td>
                                <span class="complete-indicator" :class="row.pair.is_complete ? 'yes' : 'no'"></span>
                            </td>
                            <td>
                                <span class="valid-indicator" :class="row.pair.is_valid ? 'yes' : 'no'"></span>
                            </td>
                            <template x-if="row.type === 'genomic'">
                                <td class="done-cell" rowspan="2">
                                    <input 
                                        type="checkbox" 
                                        :checked="row.pair.is_done"
                                        :hx-post="'/api/done/' + row.pair.case_id"
                                        :hx-vals="JSON.stringify({done: !row.pair.is_done})"
                                        :hx-target="'#pair-genomic-' + row.pair.case_id"
                                        hx-swap="outerHTML"
                                        hx-indicator="#loading">
                                </td>
                            </template>
                            <template x-if="row.type === 'genomic-only' || row.type === 'clinical-only'">
                                <td class="done-cell">
                                    <span>â€”</span>
                                </td>
                            </template>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        {% endif %}
    </div>
    
    <script id="pairs-data" type="application/json">
        {{ pairs | tojson | safe }}
    </script>
    
    <script>
        // Global copy function for onclick handlers (used by HTMX-swapped content)
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('Copied to clipboard:', text);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                console.log('Copied to clipboard (fallback):', text);
            } catch (err) {
                console.error('Fallback copy failed:', err);
            }
            document.body.removeChild(textArea);
        }
        
        function tableData() {
            const pairsData = JSON.parse(document.getElementById('pairs-data').textContent);
            
            // Pre-calculate initial sort positions before returning the component
            const initialSortPositions = new Map();
            pairsData.forEach((pair, index) => {
                initialSortPositions.set(pair.case_id, index);
            });
            
            return {
                pairs: pairsData,
                filter: '',
                sortColumn: 'priority_group',
                sortDirection: 'asc',
                interactedPairs: new Set(), // Track pairs that have been toggled
                initialSortPositions: initialSortPositions, // Store initial sort position for each pair
                
                get interleavedRows() {
                    const rows = [];
                    const sorted = this.filteredAndSorted;
                    
                    sorted.forEach(pair => {
                        if (pair.genomic && pair.clinical && !this.htmxManagedPairs.has(pair.case_id)) {
                            // Complete pair: add both genomic and clinical rows
                            rows.push({ type: 'genomic', pair: pair });
                            rows.push({ type: 'clinical', pair: pair });
                        } else if (pair.genomic && !pair.clinical) {
                            // Genomic only
                            rows.push({ type: 'genomic-only', pair: pair });
                        } else if (!pair.genomic && pair.clinical) {
                            // Clinical only
                            rows.push({ type: 'clinical-only', pair: pair });
                        }
                    });
                    
                    return rows;
                },
                
                get filteredAndSorted() {
                    let filtered = this.filter === '' 
                        ? [...this.pairs]  // Create a copy to avoid mutating original
                        : this.pairs.filter(pair => {
                            // Search across all columns
                            const searchStr = this.filter.toLowerCase();
                            return (
                                (pair.case_id && pair.case_id.toLowerCase().includes(searchStr)) ||
                                (pair.genomic && (
                                    pair.genomic.vorgangsnummer.toLowerCase().includes(searchStr) ||
                                    pair.genomic.meldebestaetigung.toLowerCase().includes(searchStr) ||
                                    pair.genomic.typ_der_meldung.toLowerCase().includes(searchStr) ||
                                    pair.genomic.indikationsbereich.toLowerCase().includes(searchStr) ||
                                    pair.genomic.ergebnis_qc.toLowerCase().includes(searchStr) ||
                                    pair.genomic.source_file.toLowerCase().includes(searchStr)
                                )) ||
                                (pair.clinical && (
                                    pair.clinical.vorgangsnummer.toLowerCase().includes(searchStr) ||
                                    pair.clinical.meldebestaetigung.toLowerCase().includes(searchStr) ||
                                    pair.clinical.typ_der_meldung.toLowerCase().includes(searchStr) ||
                                    pair.clinical.indikationsbereich.toLowerCase().includes(searchStr) ||
                                    pair.clinical.ergebnis_qc.toLowerCase().includes(searchStr) ||
                                    pair.clinical.source_file.toLowerCase().includes(searchStr)
                                ))
                            );
                        });
                    
                    return filtered.sort((a, b) => {
                        // If either pair has been interacted with, use initial sort position
                        const aInteracted = this.interactedPairs.has(a.case_id);
                        const bInteracted = this.interactedPairs.has(b.case_id);
                        
                        if (aInteracted || bInteracted) {
                            // Use initial positions to maintain order
                            const aPos = this.initialSortPositions.get(a.case_id) ?? 999999;
                            const bPos = this.initialSortPositions.get(b.case_id) ?? 999999;
                            return aPos - bPos;
                        }
                        
                        // Neither interacted: use normal priority group sorting
                        if (a.priority_group !== b.priority_group) {
                            return a.priority_group - b.priority_group;
                        }
                        
                        // Secondary sort: selected column
                        let aVal = this.getColumnValue(a, this.sortColumn);
                        let bVal = this.getColumnValue(b, this.sortColumn);
                        
                        if (this.sortDirection === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                },
                
                getColumnValue(pair, column) {
                    if (column === 'case_id') return pair.case_id || '';
                    // For other columns, use genomic record if available, otherwise clinical
                    const record = pair.genomic || pair.clinical;
                    if (!record) return '';
                    return record[column] || '';
                },
                
                sortBy(column) {
                    if (this.sortColumn === column) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortColumn = column;
                        this.sortDirection = 'asc';
                    }
                },
                
                htmxManagedPairs: new Set(),
                
                updatePairDoneStatus(caseId, isDone) {
                    // Mark this pair as managed by HTMX
                    this.htmxManagedPairs.add(caseId);
                    // Mark this pair as interacted with (so it won't move on re-sort)
                    this.interactedPairs.add(caseId);
                    // Update the pair's done status in Alpine.js data
                    const pair = this.pairs.find(p => p.case_id === caseId);
                    if (pair) {
                        pair.is_done = isDone;
                        // Update priority group: 1 for complete not done, 3 for complete done
                        pair.priority_group = isDone ? 3 : 1;
                    }
                },
                
                isHtmxManaged(caseId) {
                    return this.htmxManagedPairs.has(caseId);
                }
            }
        }
        
        // Listen for HTMX beforeSwap event to remove Alpine.js rendered rows
        document.body.addEventListener('htmx:beforeSwap', function(event) {
            // Check if this was a done status update
            if (event.detail.target && event.detail.target.id && event.detail.target.id.startsWith('pair-genomic-')) {
                const caseId = event.detail.target.id.replace('pair-genomic-', '');
                // Find and remove the Alpine.js rendered clinical row
                const clinicalRows = document.querySelectorAll(`tr.clinical[data-case-id="${caseId}"]`);
                clinicalRows.forEach(row => {
                    // Only remove if it doesn't have an ID (Alpine.js rendered)
                    if (!row.id) {
                        row.remove();
                    }
                });
            }
        });
        
        // Listen for HTMX afterSwap event to update Alpine.js data
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Check if this was a done status update
            if (event.detail.target && event.detail.target.id && event.detail.target.id.startsWith('pair-genomic-')) {
                const caseId = event.detail.target.id.replace('pair-genomic-', '');
                // Extract the new done status from the swapped content
                const checkbox = event.detail.target.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    const isDone = checkbox.checked;
                    // Get Alpine.js component and update data
                    const alpineComponent = Alpine.$data(document.querySelector('[x-data]'));
                    if (alpineComponent && alpineComponent.updatePairDoneStatus) {
                        alpineComponent.updatePairDoneStatus(caseId, isDone);
                    }
                }
            }
        });
    </script>
</body>
</html>
